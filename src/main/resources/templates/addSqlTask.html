<!DOCTYPE HTML>
<html xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml"
      layout:decorate="~{fragments/main_layout}">
<head>
    <title>Quick Soft - Add sql task</title>
</head>
<body>
<div layout:fragment="content" class="container">

    <div class="row">
        <div class="col-md-8 offset-md-3">
            <code>
                <span class="mark">RedisKey</span> - это первый столбец в таблице.<br>
            </code>
        </div>
    </div>

    <form th:object="${form}" method="post" th:action="@{/addSqlTask}" id="form" >
        <input type="hidden" class="form-control" th:field="*{id}">
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" th:field="*{exportType}" id="redisRadio" value="redis" checked>
                    <label class="form-check-label" for="redisRadio">Redis</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" th:field="*{exportType}" id="csvRadio" value="csv">
                    <label class="form-check-label" for="csvRadio">CSV</label>
                </div>
            </div>
        </div>

        <div id="redis-block">
            <div class="row">
                <div class="col-md-4">
                    <label for="toDbId" class="form-label">Redis</label><a th:href="@{/addRedis}">Add</a>
                    <select th:field="*{redisId}" size="5" class="form-select" aria-label="Default select example"
                            id="toDbId">
                        <option th:each="db : ${toDbs}"
                                th:text="${db.name}"
                                th:value="${db.id}">
                    </select>
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Name</label>
                            <input th:field="*{name}" type="text" class="form-control" id="name">
                        </div>
                        <div class="col-md-6">
                            <label for="group-name" class="form-label">GroupName</label>
                            <input th:field="*{groupName}" type="text" class="form-control" id="group-name" list="groups">
                            <datalist id="groups">
                                <option th:each="group : ${groups}"
                                        th:text="${group}"
                                        th:value="${group}">
                            </datalist>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <label for="redisTable" class="form-label">RedisTable</label>
                            <input th:field="*{redisTable}" type="text" class="form-control" id="redisTable">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="csv-block" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <label for="group-name-csv" class="form-label">GroupName</label>
                    <input th:field="*{groupName}" type="text" class="form-control" id="group-name-csv" list="groups">
                </div>
                <div class="col-md-6">
                    <label for="name-csv" class="form-label">Name</label>
                    <input th:field="*{name}" type="text" class="form-control" id="name-csv">
                </div>
            </div>
             <div class="row mt-3">
                <div class="col-md-12">
                    <label for="csvPath" class="form-label">CSV File Path</label>
                    <input th:field="*{csvPath}" type="text" class="form-control" id="csvPath">
                </div>
            </div>
        </div>


        <div class="row mt-3">
            <div class="col-md-12">
        <table class="table table-sm" id="table-data">
            <thead>
            <tr>
                <th>Database</th>
                <th>Query</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="queries">
            <tr class="query-row" th:each="task,iterStat : ${form.rows}">
                <td>
                    <select  size="5" class="form-select" th:field="*{rows[__${iterStat.index}__].fromDbId}">
                        <option th:each="db : ${fromDbs}"
                                th:text="${db.name}"
                                th:value="${db.id}"
                                th:selected="${db.id}==${task.fromDbId}?true:false">
                    </select>
                </td>
                <td>
                    <textarea  th:field="*{rows[__${iterStat.index}__].query}"  class="form-control" th:text="${task.query}" rows="10"></textarea>
                </td>

            </tr>
            </tbody>
        </table>
            </div>

        </div>

        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <div>
                        <button type="submit" class="btn btn-primary">Save</button>
                        <a th:if="${form.id != 0}" th:href="@{'/deleteTask/' + ${form.id}}" class="btn btn-danger">Delete</a>
                        <button type="button" id="test" class="btn btn-secondary">Test</button>
                        <div id="spinner" style="display: none;">...</div>
                    </div>
                    <div>
                        <button type="button" id="add_row" class="btn btn-success">+</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="row mt-3">
        <div class="col-md-12">
            <label for="output" class="form-label">Output</label>
            <div id="output"></div>
        </div>
    </div>
    <div th:replace = "~{fragments/scripts.html :: sql}"></div>
    <script>
        $(document).ready(function() {
            $('input[type=radio][name=exportType]').change(function() {
                if (this.value == 'csv') {
                    $('#csv-block').show();
                    $('#redis-block').hide();
                    // copy values from redis to csv section
                     $('#group-name-csv').val($('#group-name').val());
                     $('#name-csv').val($('#name').val());

                }
                else if (this.value == 'redis') {
                    $('#csv-block').hide();
                    $('#redis-block').show();
                     // copy values from csv to redis section
                     $('#group-name').val($('#group-name-csv').val());
                     $('#name').val($('#name-csv').val());
                }
            });
            // Trigger the change event on page load to set the initial state
            $('input[type=radio][name=exportType]:checked').trigger('change');
        });
    </script>
</div>
</body>
</html>